server {
    listen 80;
    server_name _;

    root /var/www/contas;
    index index.php;
    autoindex off;

    ######################################################################
    # 1. Deny everything by default
    ######################################################################
    location / {
        return 403;
    }

    ######################################################################
    # 2. Allow PHP files in root
    ######################################################################
    location ~ ^/(.*\.php)$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PHP_VALUE "auto_prepend_file=prepend.php";
        fastcgi_param PHP_FLAG "display_errors=Off";
        fastcgi_param PHP_FLAG "display_startup_errors=Off";
        fastcgi_param PHP_FLAG "output_buffering=Off";
    }

    ######################################################################
    # 3. Allow static assets in root, /assets, /public
    ######################################################################
    location ~ ^/(.*\.(css|js|png|jpg|jpeg|gif|svg|ico))$ {
        try_files $uri =404;
        access_log off;
        expires 30d;
    }

    location ^~ /assets/ { try_files $uri =404; access_log off; expires 30d; }
    location ^~ /public/ { try_files $uri =404; access_log off; expires 30d; }

    ######################################################################
    # 4. Protect sensitive files globally
    ######################################################################
    location ~* \.(json|md|log|ini|env|lock|dist|config|yaml|yml)$ { deny all; }
    location ~* ^/composer\.(json|lock)$ { deny all; }
    location ~ /\. { deny all; }
}
